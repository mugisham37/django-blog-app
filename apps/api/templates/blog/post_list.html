{% extends "blog/base.html" %}
{% load static %}

{% block title %}{{ seo_title }}{% endblock %}

{% block meta_description %}{{ seo_description }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <!-- Main Content -->
        <div class="col-lg-8">
            <!-- Page Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1 class="h2 mb-1">
                        {% if current_filters.search %}
                            Search Results for "{{ current_filters.search }}"
                        {% elif current_category_obj %}
                            {{ current_category_obj.name }}
                        {% elif current_tag_obj %}
                            Posts tagged "{{ current_tag_obj.name }}"
                        {% elif current_author_obj %}
                            Posts by {{ current_author_obj.get_full_name|default:current_author_obj.username }}
                        {% else %}
                            Latest Blog Posts
                        {% endif %}
                    </h1>
                    
                    {% if pagination_info %}
                        <p class="text-muted mb-0">
                            Showing {{ pagination_info.start_index }}-{{ pagination_info.end_index }} 
                            of {{ pagination_info.total_posts }} posts
                        </p>
                    {% endif %}
                </div>
                
                <!-- View Toggle and Sort -->
                <div class="d-flex align-items-center gap-2">
                    <div class="btn-group" role="group" aria-label="View toggle">
                        <input type="radio" class="btn-check" name="view-toggle" id="grid-view" checked>
                        <label class="btn btn-outline-secondary btn-sm" for="grid-view">
                            <i class="fas fa-th"></i>
                        </label>
                        <input type="radio" class="btn-check" name="view-toggle" id="list-view">
                        <label class="btn btn-outline-secondary btn-sm" for="list-view">
                            <i class="fas fa-list"></i>
                        </label>
                    </div>
                </div>
            </div>
            
            <!-- Breadcrumbs -->
            {% if breadcrumbs %}
                <nav aria-label="breadcrumb" class="mb-4">
                    <ol class="breadcrumb">
                        {% for crumb in breadcrumbs %}
                            {% if forloop.last %}
                                <li class="breadcrumb-item active" aria-current="page">{{ crumb.title }}</li>
                            {% else %}
                                <li class="breadcrumb-item">
                                    <a href="{{ crumb.url }}">{{ crumb.title }}</a>
                                </li>
                            {% endif %}
                        {% endfor %}
                    </ol>
                </nav>
            {% endif %}
            
            <!-- Active Filters -->
            {% if current_filters.search or current_filters.category or current_filters.tag or current_filters.author or current_filters.featured %}
                <div class="active-filters mb-4">
                    <div class="d-flex flex-wrap align-items-center gap-2">
                        <span class="text-muted">Active filters:</span>
                        
                        {% if current_filters.search %}
                            <span class="badge bg-primary">
                                Search: {{ current_filters.search }}
                                <a href="?{% for key, value in request.GET.items %}{% if key != 'q' %}{{ key }}={{ value }}&{% endif %}{% endfor %}" 
                                   class="text-white ms-1" title="Remove filter">×</a>
                            </span>
                        {% endif %}
                        
                        {% if current_category_obj %}
                            <span class="badge bg-info">
                                Category: {{ current_category_obj.name }}
                                <a href="?{% for key, value in request.GET.items %}{% if key != 'category' %}{{ key }}={{ value }}&{% endif %}{% endfor %}" 
                                   class="text-white ms-1" title="Remove filter">×</a>
                            </span>
                        {% endif %}
                        
                        {% if current_tag_obj %}
                            <span class="badge bg-success">
                                Tag: {{ current_tag_obj.name }}
                                <a href="?{% for key, value in request.GET.items %}{% if key != 'tag' %}{{ key }}={{ value }}&{% endif %}{% endfor %}" 
                                   class="text-white ms-1" title="Remove filter">×</a>
                            </span>
                        {% endif %}
                        
                        {% if current_author_obj %}
                            <span class="badge bg-warning">
                                Author: {{ current_author_obj.get_full_name|default:current_author_obj.username }}
                                <a href="?{% for key, value in request.GET.items %}{% if key != 'author' %}{{ key }}={{ value }}&{% endif %}{% endfor %}" 
                                   class="text-white ms-1" title="Remove filter">×</a>
                            </span>
                        {% endif %}
                        
                        {% if current_filters.featured %}
                            <span class="badge bg-danger">
                                Featured Only
                                <a href="?{% for key, value in request.GET.items %}{% if key != 'featured' %}{{ key }}={{ value }}&{% endif %}{% endfor %}" 
                                   class="text-white ms-1" title="Remove filter">×</a>
                            </span>
                        {% endif %}
                        
                        <a href="{% url 'blog:post_list' %}" class="btn btn-sm btn-outline-secondary">
                            Clear All
                        </a>
                    </div>
                </div>
            {% endif %}
            
            <!-- Posts Grid/List -->
            <div id="posts-container" class="posts-grid">
                {% if posts %}
                    <div class="row" id="posts-row">
                        {% for post in posts %}
                            <div class="col-md-6 col-lg-4 mb-4 post-item">
                                <article class="card h-100 post-card">
                                    {% if post.featured_image %}
                                        <div class="card-img-top-wrapper">
                                            <img src="{{ post.featured_image.url }}" 
                                                 class="card-img-top" 
                                                 alt="{{ post.title }}"
                                                 loading="lazy">
                                            {% if post.is_featured %}
                                                <span class="badge bg-warning position-absolute top-0 start-0 m-2">
                                                    <i class="fas fa-star"></i> Featured
                                                </span>
                                            {% endif %}
                                        </div>
                                    {% else %}
                                        <div class="card-img-top placeholder-img d-flex align-items-center justify-content-center">
                                            <i class="fas fa-image fa-3x text-muted"></i>
                                            {% if post.is_featured %}
                                                <span class="badge bg-warning position-absolute top-0 start-0 m-2">
                                                    <i class="fas fa-star"></i> Featured
                                                </span>
                                            {% endif %}
                                        </div>
                                    {% endif %}
                                    
                                    <div class="card-body d-flex flex-column">
                                        <div class="post-meta mb-2">
                                            {% if post.category %}
                                                <a href="?category={{ post.category.slug }}" 
                                                   class="category-badge text-decoration-none">
                                                    {{ post.category.name }}
                                                </a>
                                            {% endif %}
                                            <small class="text-muted ms-2">
                                                {{ post.published_at|date:"M d, Y" }}
                                            </small>
                                        </div>
                                        
                                        <h5 class="card-title">
                                            <a href="{{ post.get_absolute_url }}" class="text-decoration-none">
                                                {{ post.title }}
                                            </a>
                                        </h5>
                                        
                                        {% if post.excerpt %}
                                            <p class="card-text post-excerpt flex-grow-1">
                                                {{ post.excerpt|truncatewords:20 }}
                                            </p>
                                        {% endif %}
                                        
                                        <div class="post-footer mt-auto">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div class="post-meta-bottom">
                                                    <small class="text-muted">
                                                        <i class="fas fa-clock"></i> {{ post.get_reading_time_display }}
                                                    </small>
                                                    <small class="text-muted ms-2">
                                                        <i class="fas fa-eye"></i> {{ post.view_count }}
                                                    </small>
                                                </div>
                                                <a href="{{ post.get_absolute_url }}" 
                                                   class="btn btn-sm btn-outline-primary">
                                                    Read More
                                                </a>
                                            </div>
                                            
                                            {% if post.tags.exists %}
                                                <div class="post-tags mt-2">
                                                    {% for tag in post.tags.all|slice:":3" %}
                                                        <a href="?tag={{ tag.slug }}" 
                                                           class="tag text-decoration-none"
                                                           style="background-color: {{ tag.color }};">
                                                            {{ tag.name }}
                                                        </a>
                                                    {% endfor %}
                                                    {% if post.tags.count > 3 %}
                                                        <span class="text-muted">+{{ post.tags.count|add:"-3" }} more</span>
                                                    {% endif %}
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </article>
                            </div>
                        {% endfor %}
                    </div>
                    
                    <!-- Pagination -->
                    {% if is_paginated %}
                        <nav aria-label="Posts pagination" class="mt-4">
                            <ul class="pagination justify-content-center">
                                {% if page_obj.has_previous %}
                                    <li class="page-item">
                                        <a class="page-link" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page=1">
                                            <i class="fas fa-angle-double-left"></i>
                                        </a>
                                    </li>
                                    <li class="page-item">
                                        <a class="page-link" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ page_obj.previous_page_number }}">
                                            <i class="fas fa-angle-left"></i>
                                        </a>
                                    </li>
                                {% endif %}
                                
                                {% for num in page_obj.paginator.page_range %}
                                    {% if page_obj.number == num %}
                                        <li class="page-item active">
                                            <span class="page-link">{{ num }}</span>
                                        </li>
                                    {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                                        <li class="page-item">
                                            <a class="page-link" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ num }}">{{ num }}</a>
                                        </li>
                                    {% endif %}
                                {% endfor %}
                                
                                {% if page_obj.has_next %}
                                    <li class="page-item">
                                        <a class="page-link" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ page_obj.next_page_number }}">
                                            <i class="fas fa-angle-right"></i>
                                        </a>
                                    </li>
                                    <li class="page-item">
                                        <a class="page-link" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ page_obj.paginator.num_pages }}">
                                            <i class="fas fa-angle-double-right"></i>
                                        </a>
                                    </li>
                                {% endif %}
                            </ul>
                        </nav>
                    {% endif %}
                    
                {% else %}
                    <!-- No Posts Found -->
                    <div class="text-center py-5">
                        <i class="fas fa-search fa-3x text-muted mb-3"></i>
                        <h3 class="text-muted">No posts found</h3>
                        <p class="text-muted">
                            {% if current_filters.search %}
                                No posts match your search criteria. Try different keywords or 
                                <a href="{% url 'blog:post_list' %}">browse all posts</a>.
                            {% else %}
                                There are no published posts yet. Check back later!
                            {% endif %}
                        </p>
                    </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Search and Filters -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-search"></i> Search & Filter
                    </h5>
                </div>
                <div class="card-body">
                    <form method="get" id="search-form">
                        <!-- Search Input -->
                        <div class="mb-3">
                            {{ search_form.q.label_tag }}
                            {{ search_form.q }}
                        </div>
                        
                        <!-- Quick Filters -->
                        <div class="row mb-3">
                            <div class="col-6">
                                {{ search_form.category.label_tag }}
                                {{ search_form.category }}
                            </div>
                            <div class="col-6">
                                {{ search_form.tag.label_tag }}
                                {{ search_form.tag }}
                            </div>
                        </div>
                        
                        <!-- Advanced Filters Toggle -->
                        <div class="mb-3">
                            <button type="button" class="btn btn-outline-secondary btn-sm" 
                                    data-bs-toggle="collapse" data-bs-target="#advanced-filters">
                                <i class="fas fa-sliders-h"></i> Advanced Filters
                            </button>
                        </div>
                        
                        <!-- Advanced Filters -->
                        <div class="collapse" id="advanced-filters">
                            <div class="row mb-3">
                                <div class="col-6">
                                    {{ search_form.author.label_tag }}
                                    {{ search_form.author }}
                                </div>
                                <div class="col-6">
                                    {{ search_form.featured.label_tag }}
                                    {{ search_form.featured }}
                                </div>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-6">
                                    {{ search_form.date_from.label_tag }}
                                    {{ search_form.date_from }}
                                </div>
                                <div class="col-6">
                                    {{ search_form.date_to.label_tag }}
                                    {{ search_form.date_to }}
                                </div>
                            </div>
                        </div>
                        
                        <!-- Sort -->
                        <div class="mb-3">
                            {{ search_form.sort.label_tag }}
                            {{ search_form.sort }}
                        </div>
                        
                        <!-- Submit Buttons -->
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-search"></i> Search
                            </button>
                            <a href="{% url 'blog:post_list' %}" class="btn btn-outline-secondary">
                                <i class="fas fa-times"></i> Clear
                            </a>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Popular Categories -->
            {% if popular_categories %}
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-folder"></i> Popular Categories
                        </h5>
                    </div>
                    <div class="card-body">
                        {% for category in popular_categories %}
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <a href="?category={{ category.slug }}" class="text-decoration-none">
                                    {{ category.name }}
                                </a>
                                <span class="badge bg-secondary">{{ category.post_count }}</span>
                            </div>
                        {% endfor %}
                        <div class="mt-3">
                            <a href="{% url 'blog:category_list' %}" class="btn btn-sm btn-outline-primary">
                                View All Categories
                            </a>
                        </div>
                    </div>
                </div>
            {% endif %}
            
            <!-- Popular Tags -->
            {% if popular_tags %}
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-tags"></i> Popular Tags
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="tag-cloud">
                            {% for tag in popular_tags %}
                                <a href="?tag={{ tag.slug }}" 
                                   class="tag text-decoration-none me-1 mb-1"
                                   style="background-color: {{ tag.color }};">
                                    {{ tag.name }}
                                    <small>({{ tag.usage_count }})</small>
                                </a>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            {% endif %}
            
            <!-- Archive -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-archive"></i> Archive
                    </h5>
                </div>
                <div class="card-body">
                    <a href="{% url 'blog:post_archive' %}" class="btn btn-outline-primary btn-sm">
                        Browse Archive
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // View toggle functionality
    const gridViewBtn = document.getElementById('grid-view');
    const listViewBtn = document.getElementById('list-view');
    const postsContainer = document.getElementById('posts-container');
    const postsRow = document.getElementById('posts-row');
    
    if (gridViewBtn && listViewBtn) {
        listViewBtn.addEventListener('change', function() {
            if (this.checked) {
                postsContainer.classList.remove('posts-grid');
                postsContainer.classList.add('posts-list');
                postsRow.classList.remove('row');
                
                // Update post items for list view
                const postItems = document.querySelectorAll('.post-item');
                postItems.forEach(item => {
                    item.classList.remove('col-md-6', 'col-lg-4');
                    item.classList.add('col-12');
                });
            }
        });
        
        gridViewBtn.addEventListener('change', function() {
            if (this.checked) {
                postsContainer.classList.remove('posts-list');
                postsContainer.classList.add('posts-grid');
                postsRow.classList.add('row');
                
                // Update post items for grid view
                const postItems = document.querySelectorAll('.post-item');
                postItems.forEach(item => {
                    item.classList.remove('col-12');
                    item.classList.add('col-md-6', 'col-lg-4');
                });
            }
        });
    }
    
    // Auto-submit search form on filter change
    const searchForm = document.getElementById('search-form');
    const filterInputs = searchForm.querySelectorAll('select');
    
    filterInputs.forEach(input => {
        input.addEventListener('change', function() {
            // Don't auto-submit for search input
            if (this.id !== 'search-input') {
                searchForm.submit();
            }
        });
    });
    
    // Search input with debounce
    const searchInput = document.getElementById('search-input');
    let searchTimeout;
    
    if (searchInput) {
        searchInput.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                if (this.value.length >= 3 || this.value.length === 0) {
                    searchForm.submit();
                }
            }, 500);
        });
    }
});
</script>
{% endblock %}